#!/bin/sh

metal="xcrun -sdk iphoneos metal"
metal_ar="xcrun -sdk iphoneos metal-ar"
metallib="xcrun -sdk iphoneos metallib"

#debug_options="-gline-tables-only"

build()
{
    $metal -std=ios-metal1.0 -arch air64 -emit-llvm -c -ffast-math -miphoneos-version-min=8.0 $debug_options $1
}

build_vertex()
{
    build "-o $1.air -DFNAME=$1 $2 ShaderVS.metal"
    $metal_ar r Noesis.metal-ar $1.air
    rm $1.air
}

build_fragment()
{
    build "-o $1.air -DFNAME=$1 $2 ShaderFS.metal"
    $metal_ar r Noesis.metal-ar $1.air
    rm $1.air
}

# Vertex shaders
build_vertex Pos_VS "-DHAS_POSITION"
build_vertex PosColor_VS "-DHAS_POSITION -DHAS_COLOR"
build_vertex PosTex0_VS "-DHAS_POSITION -DHAS_UV0"
build_vertex PosColorCoverage_VS "-DHAS_POSITION -DHAS_COLOR -DHAS_COVERAGE"
build_vertex PosTex0Coverage_VS "-DHAS_POSITION -DHAS_UV0 -DHAS_COVERAGE"
build_vertex PosColorTex1_VS "-DHAS_POSITION -DHAS_COLOR -DHAS_UV1"
build_vertex PosTex0Tex1_VS "-DHAS_POSITION -DHAS_UV0 -DHAS_UV1"
build_vertex PosColorTex1Tex2_VS "-DHAS_POSITION -DHAS_COLOR -DHAS_UV1 -DHAS_UV2"
build_vertex PosTex0Tex1Tex2_VS "-DHAS_POSITION -DHAS_UV0 -DHAS_UV1 -DHAS_UV2"
build_vertex PosColorTex1_SDF_VS "-DHAS_POSITION -DHAS_COLOR -DHAS_UV1 -DHAS_ST1"
build_vertex PosTex0Tex1_SDF_VS "-DHAS_POSITION -DHAS_UV0 -DHAS_UV1 -DHAS_ST1"

# Fragment shaders
build_fragment RGBA_FS "-DEFFECT_RGBA"

build_fragment PathSolid_FS "-DEFFECT_PATH_SOLID"
build_fragment PathLinear_FS "-DEFFECT_PATH_LINEAR"
build_fragment PathRadial_FS "-DEFFECT_PATH_RADIAL"
build_fragment PathPattern_FS "-DEFFECT_PATH_PATTERN"

build_fragment PathAASolid_FS "-DEFFECT_PATH_AA_SOLID"
build_fragment PathAALinear_FS "-DEFFECT_PATH_AA_LINEAR"
build_fragment PathAARadial_FS "-DEFFECT_PATH_AA_RADIAL"
build_fragment PathAAPattern_FS "-DEFFECT_PATH_AA_PATTERN"

build_fragment SDFSolid_FS "-DEFFECT_SDF_SOLID"
build_fragment SDFLinear_FS "-DEFFECT_SDF_LINEAR"
build_fragment SDFRadial_FS "-DEFFECT_SDF_RADIAL"
build_fragment SDFPattern_FS "-DEFFECT_SDF_PATTERN"

build_fragment ImageOpacitySolid_FS "-DEFFECT_IMAGE_OPACITY_SOLID"
build_fragment ImageOpacityLinear_FS "-DEFFECT_IMAGE_OPACITY_LINEAR"
build_fragment ImageOpacityRadial_FS "-DEFFECT_IMAGE_OPACITY_RADIAL"
build_fragment ImageOpacityPattern_FS "-DEFFECT_IMAGE_OPACITY_PATTERN"

build_fragment ImageShadow35V_FS "-DEFFECT_IMAGE_SHADOW_35V"
build_fragment ImageShadow63V_FS "-DEFFECT_IMAGE_SHADOW_63V"
build_fragment ImageShadow127V_FS "-DEFFECT_IMAGE_SHADOW_127V"

build_fragment ImageShadow35HSolid_FS "-DEFFECT_IMAGE_SHADOW_35H_SOLID"
build_fragment ImageShadow35HLinear_FS "-DEFFECT_IMAGE_SHADOW_35H_LINEAR"
build_fragment ImageShadow35HRadial_FS "-DEFFECT_IMAGE_SHADOW_35H_RADIAL"
build_fragment ImageShadow35HPattern_FS "-DEFFECT_IMAGE_SHADOW_35H_PATTERN"

build_fragment ImageShadow63HSolid_FS "-DEFFECT_IMAGE_SHADOW_63H_SOLID"
build_fragment ImageShadow63HLinear_FS "-DEFFECT_IMAGE_SHADOW_63H_LINEAR"
build_fragment ImageShadow63HRadial_FS "-DEFFECT_IMAGE_SHADOW_63H_RADIAL"
build_fragment ImageShadow63HPattern_FS "-DEFFECT_IMAGE_SHADOW_63H_PATTERN"

build_fragment ImageShadow127HSolid_FS "-DEFFECT_IMAGE_SHADOW_127H_SOLID"
build_fragment ImageShadow127HLinear_FS "-DEFFECT_IMAGE_SHADOW_127H_LINEAR"
build_fragment ImageShadow127HRadial_FS "-DEFFECT_IMAGE_SHADOW_127H_RADIAL"
build_fragment ImageShadow127HPattern_FS "-DEFFECT_IMAGE_SHADOW_127H_PATTERN"

build_fragment ImageBlur35V_FS "-DEFFECT_IMAGE_BLUR_35V"
build_fragment ImageBlur63V_FS "-DEFFECT_IMAGE_BLUR_63V"
build_fragment ImageBlur127V_FS "-DEFFECT_IMAGE_BLUR_127V"

build_fragment ImageBlur35HSolid_FS "-DEFFECT_IMAGE_BLUR_35H_SOLID"
build_fragment ImageBlur35HLinear_FS "-DEFFECT_IMAGE_BLUR_35H_LINEAR"
build_fragment ImageBlur35HRadial_FS "-DEFFECT_IMAGE_BLUR_35H_RADIAL"
build_fragment ImageBlur35HPattern_FS "-DEFFECT_IMAGE_BLUR_35H_PATTERN"

build_fragment ImageBlur63HSolid_FS "-DEFFECT_IMAGE_BLUR_63H_SOLID"
build_fragment ImageBlur63HLinear_FS "-DEFFECT_IMAGE_BLUR_63H_LINEAR"
build_fragment ImageBlur63HRadial_FS "-DEFFECT_IMAGE_BLUR_63H_RADIAL"
build_fragment ImageBlur63HPattern_FS "-DEFFECT_IMAGE_BLUR_63H_PATTERN"

build_fragment ImageBlur127HSolid_FS "-DEFFECT_IMAGE_BLUR_127H_SOLID"
build_fragment ImageBlur127HLinear_FS "-DEFFECT_IMAGE_BLUR_127H_LINEAR"
build_fragment ImageBlur127HRadial_FS "-DEFFECT_IMAGE_BLUR_127H_RADIAL"
build_fragment ImageBlur127HPattern_FS "-DEFFECT_IMAGE_BLUR_127H_PATTERN"

# Clear shader
build "-o Clear.air Clear.metal"
$metal_ar r Noesis.metal-ar Clear.air
rm Clear.air

# Lib generation
$metallib -o Noesis.metallib Noesis.metal-ar
rm Noesis.metal-ar

# Compress
./Pack Noesis.metallib Noesis.z
rm Noesis.metallib

# Header generation
./bin2h.py Noesis.z Shaders > Shaders.ios.h
rm Noesis.z